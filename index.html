<!DOCTYPE html>
<html>
<head>
<title>AR.js A-Frame</title>
<script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
<script src="https://cdn.rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.js"></script>
<script src="https://cdn.rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
<script>
  AFRAME.registerComponent('clicker', {
      init: function() {
          const cameraEl = document.querySelector('a-camera');
          let position, cameraPos;
          this.el.addEventListener('click', e => {
              position = this.el.object3D.position; 
              cameraPos = cameraEl.object3D.position;
              alert(`Box clicked! Position is: ${position.x} ${position.y} ${position.z}; camera pos ${cameraPos.x} ${cameraPos.y} ${cameraPos.z}`);
          });
      }
  });

  let heading = 0;
  let initialHeading = false;

  function startCompass() {
    DeviceOrientationEvent.requestPermission()
      .then((response) => {
        if (response === "granted") {
          window.addEventListener("deviceorientation", (event) => {
            if (event.webkitCompassHeading) {    
              this.heading = event.webkitCompassHeading;
              var x = document.getElementById("orientinfo");
              x.innerHTML = event.webkitCompassHeading.toFixed(2) + " : " + event.alpha.toFixed(2) + " : " + event.beta.toFixed(2) + " : " + event.gamma.toFixed(2);
              if (!this.initialHeading) {
                setHeading();
                this.initialHeading = true;
              }
            }
          });
        } else {
          alert("Permission is required!");
        }
      })
      .catch(() => alert("Permission not supported"));
  }
  
  function setHeading() {
    const el = document.querySelector("[gps-new-camera]");
    if (el) {
      alert("Camera found!");
      el.setAttribute("arjs-device-orientation-controls", "headingOffset", -this.heading);
    } else {
      alert("Camera not found");
    }
  }

  window.onload = () => {
    let testEntitiesAdded = false;

    this.orientationChangeEventName =
      "ondeviceorientationabsolute" in window
        ? "deviceorientationabsolute"
        : "deviceorientation";

    if (window.DeviceOrientationEvent !== undefined && typeof window.DeviceOrientationEvent.requestPermission === "function") {
      startCompass();
    } else {
      window.addEventListener("deviceorientationabsolute", (event) => {
        if (event.webkitCompassHeading) {
          var x = document.getElementById("orientinfo");
          x.innerHTML = event.webkitCompassHeading.toFixed(2) + " : " + event.beta.toFixed(2);
        } else {
          var x = document.getElementById("orientinfo");
          x.innerHTML = event.alpha.toFixed(2) + " : " + event.beta.toFixed(2) + " : " + event.gamma.toFixed(2);
        }
      });
    }

    const el = document.querySelector("[gps-new-camera]");
    el.addEventListener("gps-camera-update-position", e => {
      if (!testEntitiesAdded) {
        const properties = [{
            color: 'red',
            latDis: 0.001,
            lonDis: 0
          },{
            color: 'yellow',
            latDis: -0.001,
            lonDis: 0
          },{
            color: 'blue',
            latDis: 0,
            lonDis: -0.001
          },{
            color: 'green',
            latDis: 0,
            lonDis: 0.001
          }
        ];
        for (const prop of properties) {
          const entity = document.createElement("a-box");
          entity.setAttribute("scale", { x: 20, y: 20, z: 20 });
          entity.setAttribute('material', { color: prop.color });
          entity.setAttribute('gps-new-entity-place', {
            latitude: e.detail.position.latitude + prop.latDis,
            longitude: e.detail.position.longitude + prop.lonDis
          });
          entity.setAttribute('clicker', {});
          document.querySelector("a-scene").appendChild(entity);
        }
        testEntitiesAdded = true;
      }
    });

    document.getElementById("go").addEventListener("click", e => {
      startCompass();
    });
  };
</script>
</head>
<body>
<a-scene vr-mode-ui='enabled: false' arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false' renderer='antialias: true; alpha: true' cursor='rayOrigin: mouse' raycaster='near: 0; far:10000'>
  <a-camera look-controls-enabled='false' arjs-device-orientation-controls='smoothingFactor: 0.99' gps-new-camera='gpsMinDistance: 5' far='5000' near='0.1'></a-camera>
</a-scene>
<div id='setloc' style='position:absolute; left: 10px; bottom: 2%; z-index:999; background-color: blue; color: white; padding: 10px'>
  <input type='button' id='go' value='Set Heading' onclick="setHeading()"/>
</div>
<div id="orientinfo" style='position:absolute; right: 10px; bottom: 2%; z-index:999; background-color: blue; color: white; padding: 10px'>Orientation .</div>
</body>
</html>